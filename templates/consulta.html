<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consulta de Cliente</title>
    <link href="static/css/home2.css" rel="stylesheet" />
</head>
<body>
    <div class="container">
        <div class="box">
            <h1 class="titulo">Consultar Cliente</h1>
            <form method="POST" action="/consulta">
                <label for="nome">NOME:</label>
                <input type="text" id="nome" name="nome" required>
                <button type="submit">Pesquisar</button>
            </form>
            
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    <!-- Exibe o título apenas uma vez, caso haja mensagens -->
                    <h7>Você tem um atendimento agendado para hoje!</h7>
            
                    <!-- Exibe todas as mensagens -->
                    {% for category, message in messages %}
                        <div class="alert">
                            <p>{{ message.split("\n")[0] }}</p>
                            <p>{{ message.split("\n")[1] }}</p>
                            <p>{{ message.split("\n")[2] }}</p>
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}

                    
            <div>    
                {% if clientes and not cliente_detalhes %}
                    <thead>
                        <table class="cabeçalho">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>CPF</th>
                                    <th>Responsável</th>
                                </tr>
                            </thead>
                        </table>
                    </thead>
                    <div class="lista-clientes-container">
                        <h2>Clientes Encontrados</h2>
                        <ul>
                            {% for cliente in clientes %}
                                <li>
                                    <form method="POST" action="/consulta">
                                        <input type="hidden" name="cpf_selecionado" value="{{ cliente[0] }}">
                                        <button type="submit">
                                            <div class="cliente-info">
                                                <span>{{ cliente[1] }}</span> <!-- Nome -->
                                                <span>{{ cliente[0] }}</span> <!-- CPF -->
                                                <span>{{ cliente[2] }}</span> <!-- Responsável -->
                                            </div>
                                        </button>
                                    </form>
                                </li>
                            {% endfor %}
                        </ul>
                    </div>
                    
                {% endif %}
                
                {% if cliente_detalhes %} 
                    <!-- Detalhes do Cliente Selecionado -->
                    <div>
                        <h2>Detalhes do Cliente</h2>
                        <div class="detalhes-cliente">
                            <div class="detalhes">
                                <table class="tabela-detalhes">
                                    <thead>
                                        <tr>
                                            <th>NOME</th>
                                            <th>CPF</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>{{ cliente_detalhes['nome'] }}</td>
                                            <td>{{ cliente_detalhes['cpf'] }}</td>
                                        </tr>

                                        <!-- Clientes relacionados -->
                                        {% for cliente_relacionado in clientes_relacionados_detalhes %}
                                            {% if cliente_relacionado['nome'] != cliente_detalhes['nome'] %}
                                                <tr>
                                                    <td>{{ cliente_relacionado['nome'] }}</td>
                                                    <td>{{ cliente_relacionado['cpf'] }}</td>
                                                </tr>
                                            {% endif %}
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            

                            <!-- Caixa de Atendimentos -->
                            <div class="caixa-atendimentos">
                                <h3>Atendimentos Realizados</h3>
                                
                                {% if atendimentos and atendimentos|length > 0 %}
                                    <table id="tabela-atendimentos">
                                        <thead>
                                            <tr>
                                                <th>Usuário</th>
                                                <th>Nome do Cliente</th>
                                                <th>Data</th>
                                                <th>Observação</th>                                                    
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for atendimento in atendimentos %}
                                                <tr>
                                                    <td>{{ atendimento.usuario }}</td>
                                                    <td>{{ atendimento.nome_cliente }}</td>                                               
                                                    <td>{{ atendimento.data_atendimento }}</td>
                                                    <td>{{ atendimento.observacao }}</td>                                                                                  
                                                </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                {% else %}
                                    <p>Nenhum atendimento encontrado.</p>
                                {% endif %}
                                <button class="add-button" onclick="toggleObservationForm()">+</button>
                            </div>

                            

                            <div id="observationForm" class="hidden">
                                <form id="formObservation" method="POST" action="/add_observation">
                                    <label for="cliente">Selecionar Cliente:</label>
                                    <select id="cliente" name="cliente" required>
                                        {% for cliente in clientes %}
                                            <option value="{{ cliente[0] }}|{{ cliente[1] }}">{{ cliente[1] }}</option>
                                        {% endfor %}
                                    </select>

                                    <label for="observation">Observação:</label>
                                    <textarea id="observation" name="observation" required></textarea>

                                    <label for="date">Data:</label>
                                    <input type="date" id="date" name="date" required>

                                    <label for="agendamento">Agendar Atendimento:</label>
                                    <input type="date" id="agendamento" name="agendamento">

                                    <button type="submit">Registrar</button>
                                </form>
                                <button type="button" onclick="toggleObservationForm()">Fechar</button>
                            </div>
                        </div>
                    </div>

                    <!-- Exibe as Notas do Cliente -->
                    <h4>Notas em Aberto</h4>
                    <div class="notas-container">
                        <table class="contas_a_receber">
                            <thead>
                                <tr>
                                    <th>Empresa</th>
                                    <th>Nome</th>
                                    <th>CPF</th>
                                    <th>Número NFe</th>
                                    <th>Parcela</th> 
                                    <th>Data da Venda</th>
                                    <th>Data do Vencimento</th>
                                    <th>Valor</th>
                                    <th>À Receber</th>  
                                </tr>
                            </thead>
                            <tbody>
                                {% set todas_notas = [] %}
                                {% for nota in cliente_detalhes["notas"] %}
                                    {% set _ = todas_notas.append({
                                        "empresa": nota.empresa,
                                        "nome": cliente_detalhes['nome'],
                                        "cpf": cliente_detalhes['cpf'],
                                        "nota": nota.nota,
                                        "parcela": nota.parcela,  
                                        "data_venda": nota.data_venda,
                                        "data_vencimento": nota.data_vencimento,
                                        "valor_original": nota.valor_original,
                                        "saldo_devedor": nota.saldo_devedor
                                    }) %}
                                {% endfor %}

                                {% for cliente_relacionado in clientes_relacionados_detalhes %}
                                    {% for nota in cliente_relacionado["notas"] %}
                                        {% set _ = todas_notas.append({
                                            "empresa": nota.empresa,
                                            "nome": cliente_relacionado['nome'],
                                            "cpf": cliente_relacionado['cpf'],
                                            "nota": nota.nota,
                                            "parcela": nota.parcela,  
                                            "data_venda": nota.data_venda,
                                            "data_vencimento": nota.data_vencimento,
                                            "valor_original": nota.valor_original,
                                            "saldo_devedor": nota.saldo_devedor
                                        }) %}
                                    {% endfor %}
                                {% endfor %}

                                {% for nota in todas_notas|sort(attribute="data_vencimento") %}
                                    <tr>
                                        <td>{{ nota.empresa }}</td>
                                        <td>{{ nota.nome }}</td>
                                        <td>{{ nota.cpf }}</td>
                                        <td>{{ nota.nota }}</td>
                                        <td>{{ nota.parcela }}</td>
                                        <td>{{ nota.data_venda }}</td>
                                        <td>
                                            <span style="color: {% if nota.data_vencimento and nota.data_vencimento < data_hoje %}red{% else %}black{% endif %};">
                                                {{ nota.data_vencimento.strftime('%d/%m/%Y') if nota.data_vencimento else 'N/A' }}
                                            </span>
                                        </td>
                                        <td>R$ {{ '{:,.2f}'.format(nota.valor_original|float).replace(',', 'X').replace('.', ',').replace('X', '.') }}</td>
                                        <td>R$ {{ '{:,.2f}'.format(nota.saldo_devedor|float).replace(',', 'X').replace('.', ',').replace('X', '.') }}</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- Exibe o total a receber -->
                    {% if cliente_detalhes['notas'] %}
                        <div class="total-a-receber">
                            <h5>Total a Receber: R$ {{ cliente_detalhes['total_a_receber'] }}</h5>
                        </div>
                    {% endif %}
                </div>
            {% endif %}
            </div>    
        </div>
    </div>
    <script>
        // Função para alternar a exibição do modal
        function toggleObservationForm() {
            const form = document.getElementById('observationForm');
            form.classList.toggle('hidden');
    
            if (form.classList.contains('hidden')) {
                const formObservation = document.getElementById('formObservation');
                formObservation.reset();
            }
        }
        
        async function carregarAtendimentos() {
            try {
                const response = await fetch('/get_atendimentos', { method: 'GET' });
                if (response.ok) {
                    const data = await response.json();
                    const tabelaAtendimentos = document.getElementById('tabela-atendimentos').getElementsByTagName('tbody')[0];
                    tabelaAtendimentos.innerHTML = ''; // Limpar a tabela antes de preencher novamente
                    
                    data.atendimentos.forEach(atendimento => {
                        const novaLinha = document.createElement('tr');
                        novaLinha.innerHTML = `
                            <td>${atendimento.cpf_cnpj}</td>
                            <td>${atendimento.nome_cliente}</td>
                            <td>${atendimento.data_atendimento}</td>
                            <td>${atendimento.observacao}</td>
                        `;
                        tabelaAtendimentos.appendChild(novaLinha);
                    });
                } else {
                    const error = await response.json();
                    console.error('Erro ao carregar atendimentos:', error.error || 'Erro desconhecido');
                }
            } catch (error) {
                console.error('Erro inesperado ao carregar atendimentos:', error);
            }
        }
    
    
        // Evento de envio do formulário
        const formObservation = document.getElementById('formObservation');
        const submitButton = formObservation.querySelector('button[type="submit"]');
        const inputsToWatch = ['cliente', 'observation', 'date'];
    
        formObservation.addEventListener('submit', async function (e) {
            e.preventDefault(); // Previne envio padrão do formulário
    
            const formData = new FormData(this);
    
            // Desabilitar botão de envio para evitar múltiplos envios
            submitButton.disabled = true;
    
            try {
                const response = await fetch('/add_observation', {
                    method: 'POST',
                    body: formData,
                });
    
                if (response.ok) {
                    await response.json(); // Apenas consome a resposta sem exibi-la
                    window.location.reload(); // Recarrega a página após o sucesso
                } else {
                    const error = await response.json();
                    alert(`Erro: ${error.error || 'Erro desconhecido'}`);
                }
    
                // Fecha apenas o modal sem redirecionar
                toggleObservationForm();
            } catch (error) {
                console.error('Erro inesperado:', error);
                alert('Erro ao processar a solicitação.');
            }
        });
    
        // Reativar o botão de envio caso algum campo seja alterado
        inputsToWatch.forEach(id => {
            const input = document.getElementById(id);
            input.addEventListener('input', () => {
                submitButton.disabled = false;
            });
        });
    
        // Carrega os atendimentos ao inicializar a página
        document.addEventListener('DOMContentLoaded', function () {
            console.log('DOM totalmente carregado, iniciando carregamento dos atendimentos...');
            carregarAtendimentos();
        });
    
        document.addEventListener('DOMContentLoaded', function () {
            console.log('DOM totalmente carregado, iniciando navegação e seleção...');
            const tabela = document.querySelector('.contas_a_receber tbody');
            let selectedRow = null; // Variável para armazenar a linha selecionada
            let currentScrollTop = tabela.scrollTop; // Armazena a posição atual de scroll

            // Adicionar evento de teclado para navegação
            document.addEventListener('keydown', function (event) {
                const rows = Array.from(tabela.querySelectorAll('tr'));

                if (!rows.length) return; // Não faz nada se não houver linhas

                if (event.key === 'ArrowDown') {
                    // Navegar para baixo
                    if (selectedRow === null) {
                        selectedRow = rows[0]; // Seleciona a primeira linha
                    } else {
                        const currentIndex = rows.indexOf(selectedRow);
                        if (currentIndex < rows.length - 1) {
                            selectedRow = rows[currentIndex + 1];
                        }
                    }
                } else if (event.key === 'ArrowUp') {
                    // Navegar para cima
                    if (selectedRow !== null) {
                        const currentIndex = rows.indexOf(selectedRow);
                        if (currentIndex > 0) {
                            selectedRow = rows[currentIndex - 1];
                        }
                    }
                }

                // Atualizar a classe de seleção
                rows.forEach(row => row.classList.remove('selected-row'));
                if (selectedRow) {
                    selectedRow.classList.add('selected-row');
                    tabela.scrollTop = currentScrollTop; // Manter a mesma posição de scroll
                }
            });

            // Clique em uma linha para selecioná-la
            tabela.addEventListener('click', function (event) {
                const clickedRow = event.target.closest('tr');
                if (!clickedRow) return;

                selectedRow = clickedRow;

                // Atualizar a classe de seleção
                const rows = Array.from(tabela.querySelectorAll('tr'));
                rows.forEach(row => row.classList.remove('selected-row'));
                selectedRow.classList.add('selected-row');

                // Manter o scroll na mesma posição vertical
                tabela.scrollTop = currentScrollTop;
            });

            // Ajustar scroll quando a seleção é alterada
            tabela.addEventListener('scroll', function () {
                currentScrollTop = tabela.scrollTop;
            });
        });    
    </script>      
</body>
</html>
